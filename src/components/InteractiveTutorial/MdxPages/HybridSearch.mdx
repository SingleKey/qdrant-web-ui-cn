export const title = '混合搜索';

# 使用稀疏和密集向量的混合搜索

在本教程中，我们将继续探索Qdrant中的混合搜索，重点关注稀疏和密集向量。
这次，我们将使用与`terraforming_plans`相关的集合，每个数据点将在`payload`中对其内容进行简要描述。

## 步骤1：创建支持稀疏向量的集合

我们将从创建一个名为`terraforming_plans`的集合开始。这个集合将同时支持用于语义相似性的密集向量和用于基于关键字的搜索的稀疏向量。

```json withRunButton=true
PUT /collections/terraforming_plans
{
    "vectors": {
        "size": 4,  
        "distance": "Cosine"  
    },
    "sparse_vectors": {
        "keywords": { }
    }
}
```

### 解释：
- **`vectors`**：配置具有4维的密集向量空间，使用余弦相似度进行距离测量。
- **`sparse_vectors`**：配置集合以支持用于基于关键字的索引的稀疏向量。

---

## 步骤2：插入带有描述的数据点

现在，我们将向`terraforming_plans`集合中插入三个数据点，每个点与不同的天体（火星、木星和金星）相关。每个点将同时具有密集和稀疏向量，以及在`payload`中的`description`。

```json withRunButton=true
PUT /collections/terraforming_plans/points
{
    "points": [
        {
            "id": 1,  
            "vector": {
                "": [0.02, 0.4, 0.5, 0.9],   // Dense vector
                "keywords": {
                   "indices": [1, 42],    // Sparse for "rocky" and "Mars"
                   "values": [0.22, 0.8]  // Weights for these keywords
                }
            },
            "payload": {
                "description": "Plans about Mars colonization."
            }
        },
        {
            "id": 2,  
            "vector": {
                "": [0.3, 0.1, 0.6, 0.4],   
                "keywords": {
                   "indices": [2, 35],    // Sparse for "gas giant" and "icy"
                   "values": [0.15, 0.65]  // Weights for these keywords
                }
            },
            "payload": {
                "description": "Study on Jupiter gas composition."
            }
        },
        {
            "id": 3,  
            "vector": {
                "": [0.7, 0.5, 0.3, 0.8],   
                "keywords": {
                   "indices": [10, 42],    // Sparse for "Venus" and "rocky"
                   "values": [0.3, 0.5]    // Weights for these keywords
                }
            },
            "payload": {
                "description": "Venus geological terrain analysis."
            }
        }
    ]
}
```

### 解释：
- **密集向量**：以数值形式表示数据点的语义特征。
- **稀疏向量（`keywords`）**：表示关键字特征，`indices`映射到特定关键字，`values`表示它们的相关性。
- **`payload`**：提供数据点内容的简短描述，使理解每个向量代表的内容更容易。

---

## 步骤3：执行混合搜索

接下来，在`terraforming_plans`集合上执行混合搜索，使用互逆排名融合（RRF）结合基于关键字的（稀疏）和语义的（密集）搜索。

```json withRunButton=true
POST /collections/terraforming_plans/points/query
{
    "prefetch": [
        {
            "query": { 
                "indices": [1, 42],   
                "values": [0.22, 0.8]  
            },
            "using": "keywords",
            "limit": 20
        },
        {
            "query": [0.01, 0.45, 0.67, 0.89],
            "using": "",
            "limit": 20
        }
    ],
    "query": { "fusion": "rrf" },  // Reciprocal rank fusion
    "limit": 10,
    "with_payload": true
}
```

### 解释：
- **`prefetch`**：包含两个子查询：
  - **基于关键字的查询**：使用稀疏向量（keywords）按关键字相关性进行搜索。
  - **密集向量查询**：使用密集向量进行语义相似性搜索。
- **`fusion: rrf`**：使用互逆排名融合（RRF）结合两个查询的结果，优先考虑在两个搜索中都排名较高的点。
- **`limit`**：将结果数量限制在前10个。

---

## 总结

在本教程中，我们：
1. 创建了一个名为`terraforming_plans`的Qdrant集合，支持使用密集和稀疏向量的混合搜索。
2. 插入了同时具有密集和稀疏向量以及在负载中带有描述的数据点。
3. 使用互逆排名融合执行了结合关键字相关性和密集向量相似性的混合搜索。

这种方法允许有效的混合搜索，结合了文本和语义搜索能力，这在涉及复杂搜索需求的应用中非常有用。